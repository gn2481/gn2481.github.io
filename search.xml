<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Rails ä¸­ includes è·Ÿ joins çš„å·®åˆ¥</title>
    <url>/2021/02/25/Rails-%E4%B8%AD-includes-%E8%B7%9F-joins-%E7%9A%84%E5%B7%AE%E5%88%A5/</url>
    <content><![CDATA[<h1 id="Rails-ä¸­-includes-è·Ÿ-joins-çš„å·®åˆ¥"><a href="#Rails-ä¸­-includes-è·Ÿ-joins-çš„å·®åˆ¥" class="headerlink" title="Rails ä¸­ includes è·Ÿ joins çš„å·®åˆ¥"></a>Rails ä¸­ <code>includes</code> è·Ÿ <code>joins</code> çš„å·®åˆ¥</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å¹«å¿™åœ¨èª¿æ ¡ç¶²ç«™ n+1 çš„å•é¡Œï¼Œæ‰€ä»¥æƒ³ä¾†å¯«å€‹ç­†è¨˜ï¼Œåˆ†æˆå…©ç¯‡ã€‚</p>
<ol>
<li><a href="">Rails ä¸­ <code>includes</code> è·Ÿ <code>joins</code> çš„å·®åˆ¥</a></li>
<li><a href="">Rails çš„ <code>length</code>ã€<code>count</code>ã€<code>size</code> å·®åˆ¥ï¼Ÿ</a></li>
</ol>
<h2 id="ä½•è¬‚-N-1-å•é¡Œ"><a href="#ä½•è¬‚-N-1-å•é¡Œ" class="headerlink" title="ä½•è¬‚ N+1 å•é¡Œ"></a>ä½•è¬‚ <code>N+1</code> å•é¡Œ</h2><p>åœ¨ Rails ä¸­å»ºç«‹ model çš„è³‡æ–™é—œè¯ååˆ†çš„å®¹æ˜“ï¼Œä½†ä¹Ÿæ˜¯å› ç‚ºå»ºç«‹æ–¹ä¾¿ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±æœƒå¯«å‡ºæ•ˆèƒ½å·®çš„ç¨‹å¼ç¢¼ï¼Œæ¯ä¸€æ¬¡é€²å‡º Database éƒ½æœƒæ¶ˆè€—å¾ˆå¤§çš„æ•ˆèƒ½ï¼Œåˆ°åº•ä½•è¬‚ <code>N+1</code> å•é¡Œå‘¢ï¼Ÿ<br>èˆ‰å€‹ä¾‹å­ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># User</span></span><br><span class="line">has_many <span class="symbol">:orders</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Order</span></span><br><span class="line">belongs_to <span class="symbol">:user</span></span><br></pre></td></tr></table></figure>
<p>ç•¶æˆ‘å€‘æƒ³åœ¨ç•«é¢ä¸Šå°å‡ºæ‰€æœ‰ <code>orders</code> çš„ <code>user.email</code>ï¼Œæ­¤æ™‚æ‰€é€ æˆçš„ <code>query</code> å°±æœƒé•·é€™æ¨£ï¼š</p>
<p><img src="https://i.imgur.com/JyR4HcK.png"></p>
<p>ä¸Šé¢çš„å¯«æ³•å°±æœƒå…ˆå°‡æ‰€æœ‰ <code>orders</code>ï¼Œæ‰¾å‡ºä¾†ï¼Œåœ¨é‡å°æ¯ä¸€ç­†çš„ <code>order.user_id</code> å»æŸ¥æ‰¾<code>users</code>çš„è¡¨ï¼Œå…±æœ‰ 9 ç­†ï¼Œæ‰€ä»¥æ‰¾ 9 æ¬¡ã€‚</p>
<p>è‹¥æœ‰ n ç­†å°±æ‰¾ n æ¬¡ï¼Œå†åŠ ä¸Šä¸€é–‹å§‹æ‰¾å‡ºæ‰€æœ‰ <code>orders</code> çš„ <code>query</code> ï¼Œå°±è®Šæˆäº† <code>n+1</code>ã€‚</p>
<p>è‹¥è³‡æ–™é‡ç¨å¾®é¾å¤§ä¸€é»ï¼Œæ•ˆèƒ½å°±æœƒè®Šå·®ã€‚</p>
<h2 id="è«‹å–„ç”¨-includes"><a href="#è«‹å–„ç”¨-includes" class="headerlink" title="è«‹å–„ç”¨ includes"></a>è«‹å–„ç”¨ <code>includes</code></h2><p>è€Œ Rails å¾ˆè²¼å¿ƒçš„æœ‰å€‹èªæ³•å¯ä»¥è®“æˆ‘å€‘é¿å…é€™æ¨£çš„å•é¡Œï¼Œ<code>includes</code>ã€‚<br>è‹¥å°‡ <code>orders = Order.all</code> æ”¹æˆ <code>orders = Order.all.includes(:user)</code><br><img src="https://i.imgur.com/mMlBCoB.png"></p>
<p>é‚£åœ¨æœ€ä¸€é–‹å§‹æ’ˆå‡ºæ‰€æœ‰ order æ™‚ï¼Œæœƒé †ä¾¿ä¸€èµ·æŠŠç›¸å°æ‡‰çš„ user æ‰¾å‡ºä¾†ï¼Œæ­¤æ™‚ç¹¼çºŒè¼¸å…¥ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">orders.each <span class="keyword">do</span> <span class="params">|order|</span></span><br><span class="line">  order.user.email</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>é€™æ™‚å°±ä¸æœƒé€²åˆ° Database ä¸­æŸ¥è©¢ã€‚<br>å¾ n+1 è®Šæˆ 1+1 ğŸ‘</p>
<h3 id="includes-ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯-ä½¿ç”¨-hash"><a href="#includes-ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯-ä½¿ç”¨-hash" class="headerlink" title="includes ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯ (ä½¿ç”¨ hash)"></a><code>includes</code> ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯ (ä½¿ç”¨ hash)</h3><p>å¦‚æœé™¤äº† <code>user</code> ï¼Œé‚„æƒ³ä¸€èµ·æ‰¾å‡ºè·Ÿ <code>user</code> æœ‰é—œè¯çš„ model å¯ä»¥ä½¿ç”¨ hash çš„å¯«æ³•</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥ profile ç‚ºä¾‹</span></span><br><span class="line"><span class="comment"># User has_many profiles</span></span><br><span class="line"></span><br><span class="line">orders = Order.all.includes(<span class="symbol">user:</span> [ <span class="symbol">:profile</span> ])</span><br><span class="line"><span class="comment"># å¯ä»¥é †ä¾¿æŠŠ profile æ’ˆå‡ºä¾†</span></span><br></pre></td></tr></table></figure>


<h2 id="é‚„æœ‰ä¸€å€‹èªæ³•å«-joins"><a href="#é‚„æœ‰ä¸€å€‹èªæ³•å«-joins" class="headerlink" title="é‚„æœ‰ä¸€å€‹èªæ³•å« joins"></a>é‚„æœ‰ä¸€å€‹èªæ³•å« <code>joins</code></h2><p>é™¤äº† <code>includes</code> ä¹‹å¤–ï¼Œé‚„æœ‰ä¸€å€‹å¾ˆåƒçš„èªæ³•å«åš <code>joins</code>ï¼Œä¸éå·®åˆ¥ç‚º <code>joins</code> æ˜¯éæ¿¾ <code>model</code> ä¹‹é–“çš„é—œè¯ï¼Œåƒä¸Šæ–¹çš„å¯«æ³•ï¼Œåœ¨å°å‡º <code>user.email</code> çš„æ™‚å€™é‚„æ˜¯æœƒç”¢ç”ŸæŸ¥è©¢ï¼</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">orders = Order.all.joins(<span class="symbol">:user</span>)</span><br><span class="line"><span class="comment"># å›å‚³å…·æœ‰ user_id çš„ order</span></span><br></pre></td></tr></table></figure>
<h4 id="è€Œ-has-many-åˆæœƒè·Ÿ-belongs-to-çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ"><a href="#è€Œ-has-many-åˆæœƒè·Ÿ-belongs-to-çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ" class="headerlink" title="è€Œ has_many åˆæœƒè·Ÿ belongs_to çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ"></a>è€Œ <code>has_many</code> åˆæœƒè·Ÿ <code>belongs_to</code> çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ</h4><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># User has_many :orders</span></span><br><span class="line">user = User.joins(<span class="symbol">:orders</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥è©¢æ‰€æœ‰å…·æœ‰ <code>user_id</code> çš„ <code>order</code>ï¼Œä¸¦å›å‚³è©² <code>order</code> çš„ <code>user</code> ï¼Œè‹¥æœ‰å¾ˆå¤š <code>order</code> æ‰€å±¬åŒä¸€å€‹ <code>user</code>ï¼Œå‰‡å›å‚³å€¼æœƒåŒ…å«å¤§é‡åŒä¸€å <code>user</code> çš„è³‡æ–™ï¼Œå¯ä»¥ç”¨ <code>uniq</code> è™•ç†ã€‚</li>
</ul>
<h2 id="ä¾†å€‹ç¸½çµï¼"><a href="#ä¾†å€‹ç¸½çµï¼" class="headerlink" title="ä¾†å€‹ç¸½çµï¼"></a>ä¾†å€‹ç¸½çµï¼</h2><p>ç°¡å–®ä¾†èªªï¼Œè‹¥æ˜¯è¦è™•ç†å¤§é‡è³‡æ–™ï¼Œæœƒæ¯”è¼ƒå»ºè­°ä½¿ç”¨ <code>includes</code>ï¼Œä»¥é¿å… n+1 çš„å•é¡Œï¼Œè€Œ <code>joins</code> çš„è©±ï¼Œç›®å‰æ¨è«–æ˜¯éœ€è¦å°è³‡æ–™åšé—œè¯ model çš„æ¢ä»¶ç¯©é¸ï¼Œæ‰æœƒæ¯”è¼ƒå»ºè­°ä½¿ç”¨ã€‚</p>
<hr>
<h4 id="åƒè€ƒæ–‡ç« "><a href="#åƒè€ƒæ–‡ç« " class="headerlink" title="åƒè€ƒæ–‡ç« "></a>åƒè€ƒæ–‡ç« </h4><p><a href="https://adlerhsieh.com/blog/20141028-rails-include-join-avoid-n-1-query">Railsä½¿ç”¨ include å’Œ join é¿å… N+1 query</a></p>
<p><a href="https://ihower.tw/rails/performance.html">Ruby on Rails å¯¦æˆ°è–ç¶“ - ç¶²ç«™æ•ˆèƒ½</a></p>
<p><a href="https://apidock.com/rails/ActiveRecord/QueryMethods/includes">å®˜æ–¹ API æ–‡ä»¶</a></p>
<p><a href="https://stackoverflow.com/questions/1208636/rails-include-vs-joins">stackoverflow</a></p>
]]></content>
      <categories>
        <category>rails</category>
      </categories>
      <tags>
        <tag>rails</tag>
      </tags>
  </entry>
</search>
