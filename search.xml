<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Rails ä¸­ includes è·Ÿ joins çš„å·®åˆ¥</title>
    <url>/2021/02/25/diffence_between_includes_and_joins/</url>
    <content><![CDATA[<h1 id="Rails-ä¸­-includes-è·Ÿ-joins-çš„å·®åˆ¥"><a href="#Rails-ä¸­-includes-è·Ÿ-joins-çš„å·®åˆ¥" class="headerlink" title="Rails ä¸­ includes è·Ÿ joins çš„å·®åˆ¥"></a>Rails ä¸­ <code>includes</code> è·Ÿ <code>joins</code> çš„å·®åˆ¥</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>æœ€è¿‘å¹«å¿™åœ¨èª¿æ ¡ç¶²ç«™ n+1 çš„å•é¡Œï¼Œæ‰€ä»¥æƒ³ä¾†å¯«å€‹ç­†è¨˜ï¼Œåˆ†æˆå…©ç¯‡ã€‚</p>
<ol>
<li><a href="">Rails ä¸­ <code>includes</code> è·Ÿ <code>joins</code> çš„å·®åˆ¥</a></li>
<li><a href="">Rails çš„ <code>length</code>ã€<code>count</code>ã€<code>size</code> å·®åˆ¥ï¼Ÿ</a></li>
</ol>
<h2 id="ä½•è¬‚-N-1-å•é¡Œ"><a href="#ä½•è¬‚-N-1-å•é¡Œ" class="headerlink" title="ä½•è¬‚ N+1 å•é¡Œ"></a>ä½•è¬‚ <code>N+1</code> å•é¡Œ</h2><p>åœ¨ Rails ä¸­å»ºç«‹ model çš„è³‡æ–™é—œè¯ååˆ†çš„å®¹æ˜“ï¼Œä½†ä¹Ÿæ˜¯å› ç‚ºå»ºç«‹æ–¹ä¾¿ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±æœƒå¯«å‡ºæ•ˆèƒ½å·®çš„ç¨‹å¼ç¢¼ï¼Œæ¯ä¸€æ¬¡é€²å‡º Database éƒ½æœƒæ¶ˆè€—å¾ˆå¤§çš„æ•ˆèƒ½ï¼Œåˆ°åº•ä½•è¬‚ <code>N+1</code> å•é¡Œå‘¢ï¼Ÿ<br>èˆ‰å€‹ä¾‹å­ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># User</span></span><br><span class="line">has_many <span class="symbol">:orders</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Order</span></span><br><span class="line">belongs_to <span class="symbol">:user</span></span><br></pre></td></tr></table></figure>
<p>ç•¶æˆ‘å€‘æƒ³åœ¨ç•«é¢ä¸Šå°å‡ºæ‰€æœ‰ <code>orders</code> çš„ <code>user.email</code>ï¼Œæ­¤æ™‚æ‰€é€ æˆçš„ <code>query</code> å°±æœƒé•·é€™æ¨£ï¼š</p>
<p><img src="https://i.imgur.com/JyR4HcK.png"></p>
<p>ä¸Šé¢çš„å¯«æ³•å°±æœƒå…ˆå°‡æ‰€æœ‰ <code>orders</code>ï¼Œæ‰¾å‡ºä¾†ï¼Œåœ¨é‡å°æ¯ä¸€ç­†çš„ <code>order.user_id</code> å»æŸ¥æ‰¾<code>users</code>çš„è¡¨ï¼Œå…±æœ‰ 9 ç­†ï¼Œæ‰€ä»¥æ‰¾ 9 æ¬¡ã€‚</p>
<p>è‹¥æœ‰ n ç­†å°±æ‰¾ n æ¬¡ï¼Œå†åŠ ä¸Šä¸€é–‹å§‹æ‰¾å‡ºæ‰€æœ‰ <code>orders</code> çš„ <code>query</code> ï¼Œå°±è®Šæˆäº† <code>n+1</code>ã€‚</p>
<p>è‹¥è³‡æ–™é‡ç¨å¾®é¾å¤§ä¸€é»ï¼Œæ•ˆèƒ½å°±æœƒè®Šå·®ã€‚</p>
<h2 id="è«‹å–„ç”¨-includes"><a href="#è«‹å–„ç”¨-includes" class="headerlink" title="è«‹å–„ç”¨ includes"></a>è«‹å–„ç”¨ <code>includes</code></h2><p>è€Œ Rails å¾ˆè²¼å¿ƒçš„æœ‰å€‹èªæ³•å¯ä»¥è®“æˆ‘å€‘é¿å…é€™æ¨£çš„å•é¡Œï¼Œ<code>includes</code>ã€‚<br>è‹¥å°‡ <code>orders = Order.all</code> æ”¹æˆ <code>orders = Order.all.includes(:user)</code><br><img src="https://i.imgur.com/mMlBCoB.png"></p>
<p>é‚£åœ¨æœ€ä¸€é–‹å§‹æ’ˆå‡ºæ‰€æœ‰ order æ™‚ï¼Œæœƒé †ä¾¿ä¸€èµ·æŠŠç›¸å°æ‡‰çš„ user æ‰¾å‡ºä¾†ï¼Œæ­¤æ™‚ç¹¼çºŒè¼¸å…¥ï¼š</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">orders.each <span class="keyword">do</span> <span class="params">|order|</span></span><br><span class="line">  order.user.email</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>é€™æ™‚å°±ä¸æœƒé€²åˆ° Database ä¸­æŸ¥è©¢ã€‚<br>å¾ n+1 è®Šæˆ 1+1 ğŸ‘</p>
<h3 id="includes-ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯-ä½¿ç”¨-hash"><a href="#includes-ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯-ä½¿ç”¨-hash" class="headerlink" title="includes ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯ (ä½¿ç”¨ hash)"></a><code>includes</code> ä¹Ÿæ”¯æ´å·¢ç‹€é—œè¯ (ä½¿ç”¨ hash)</h3><p>å¦‚æœé™¤äº† <code>user</code> ï¼Œé‚„æƒ³ä¸€èµ·æ‰¾å‡ºè·Ÿ <code>user</code> æœ‰é—œè¯çš„ model å¯ä»¥ä½¿ç”¨ hash çš„å¯«æ³•</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥ profile ç‚ºä¾‹</span></span><br><span class="line"><span class="comment"># User has_many profiles</span></span><br><span class="line"></span><br><span class="line">orders = Order.all.includes(<span class="symbol">user:</span> [ <span class="symbol">:profile</span> ])</span><br><span class="line"><span class="comment"># å¯ä»¥é †ä¾¿æŠŠ profile æ’ˆå‡ºä¾†</span></span><br></pre></td></tr></table></figure>


<h2 id="é‚„æœ‰ä¸€å€‹èªæ³•å«-joins"><a href="#é‚„æœ‰ä¸€å€‹èªæ³•å«-joins" class="headerlink" title="é‚„æœ‰ä¸€å€‹èªæ³•å« joins"></a>é‚„æœ‰ä¸€å€‹èªæ³•å« <code>joins</code></h2><p>é™¤äº† <code>includes</code> ä¹‹å¤–ï¼Œé‚„æœ‰ä¸€å€‹å¾ˆåƒçš„èªæ³•å«åš <code>joins</code>ï¼Œä¸éå·®åˆ¥ç‚º <code>joins</code> æ˜¯éæ¿¾ <code>model</code> ä¹‹é–“çš„é—œè¯ï¼Œåƒä¸Šæ–¹çš„å¯«æ³•ï¼Œåœ¨å°å‡º <code>user.email</code> çš„æ™‚å€™é‚„æ˜¯æœƒç”¢ç”ŸæŸ¥è©¢ï¼</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">orders = Order.all.joins(<span class="symbol">:user</span>)</span><br><span class="line"><span class="comment"># å›å‚³å…·æœ‰ user_id çš„ order</span></span><br></pre></td></tr></table></figure>
<h4 id="è€Œ-has-many-åˆæœƒè·Ÿ-belongs-to-çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ"><a href="#è€Œ-has-many-åˆæœƒè·Ÿ-belongs-to-çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ" class="headerlink" title="è€Œ has_many åˆæœƒè·Ÿ belongs_to çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ"></a>è€Œ <code>has_many</code> åˆæœƒè·Ÿ <code>belongs_to</code> çš„æƒ…å¢ƒæœ‰ä¸ä¸€æ¨£çš„å›å‚³çµæœ</h4><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># User has_many :orders</span></span><br><span class="line">user = User.joins(<span class="symbol">:orders</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥è©¢æ‰€æœ‰å…·æœ‰ <code>user_id</code> çš„ <code>order</code>ï¼Œä¸¦å›å‚³è©² <code>order</code> çš„ <code>user</code> ï¼Œè‹¥æœ‰å¾ˆå¤š <code>order</code> æ‰€å±¬åŒä¸€å€‹ <code>user</code>ï¼Œå‰‡å›å‚³å€¼æœƒåŒ…å«å¤§é‡åŒä¸€å <code>user</code> çš„è³‡æ–™ï¼Œå¯ä»¥ç”¨ <code>uniq</code> è™•ç†ã€‚</li>
</ul>
<h2 id="ä¾†å€‹ç¸½çµï¼"><a href="#ä¾†å€‹ç¸½çµï¼" class="headerlink" title="ä¾†å€‹ç¸½çµï¼"></a>ä¾†å€‹ç¸½çµï¼</h2><p>ç°¡å–®ä¾†èªªï¼Œè‹¥æ˜¯è¦è™•ç†å¤§é‡è³‡æ–™ï¼Œæœƒæ¯”è¼ƒå»ºè­°ä½¿ç”¨ <code>includes</code>ï¼Œä»¥é¿å… n+1 çš„å•é¡Œï¼Œè€Œ <code>joins</code> çš„è©±ï¼Œç›®å‰æ¨è«–æ˜¯éœ€è¦å°è³‡æ–™åšé—œè¯ model çš„æ¢ä»¶ç¯©é¸ï¼Œæ‰æœƒæ¯”è¼ƒå»ºè­°ä½¿ç”¨ã€‚</p>
<hr>
<h4 id="åƒè€ƒæ–‡ç« "><a href="#åƒè€ƒæ–‡ç« " class="headerlink" title="åƒè€ƒæ–‡ç« "></a>åƒè€ƒæ–‡ç« </h4><p><a href="https://adlerhsieh.com/blog/20141028-rails-include-join-avoid-n-1-query">Railsä½¿ç”¨ include å’Œ join é¿å… N+1 query</a></p>
<p><a href="https://ihower.tw/rails/performance.html">Ruby on Rails å¯¦æˆ°è–ç¶“ - ç¶²ç«™æ•ˆèƒ½</a></p>
<p><a href="https://apidock.com/rails/ActiveRecord/QueryMethods/includes">å®˜æ–¹ API æ–‡ä»¶</a></p>
<p><a href="https://stackoverflow.com/questions/1208636/rails-include-vs-joins">stackoverflow</a></p>
]]></content>
      <categories>
        <category>Ruby on Rails</category>
      </categories>
      <tags>
        <tag>Ruby on Rails</tag>
        <tag>n+1</tag>
      </tags>
  </entry>
  <entry>
    <title>Feature Toggles</title>
    <url>/2021/08/09/feature_toggles/</url>
    <content><![CDATA[<h1 id="ä»€éº¼æ˜¯-feature-toggleï¼Ÿ"><a href="#ä»€éº¼æ˜¯-feature-toggleï¼Ÿ" class="headerlink" title="ä»€éº¼æ˜¯ feature toggleï¼Ÿ"></a>ä»€éº¼æ˜¯ feature toggleï¼Ÿ</h1><p>è‹¥ä¸€å€‹åŠŸèƒ½è¦æˆåŠŸä¸Šç·šéœ€æœ‰ï¼š<br><img src="https://i.imgur.com/ikSwJjG.png"></p>
<hr>
<p>ä¸€èˆ¬é–‹ç™¼æ–¹å¼å¤§è‡´åˆ†æˆä¸‹é¢å¹¾ç¨®ï¼š</p>
<p><strong>One branch</strong> <em>(æœ€ç°¡å–®çš„æ–¹å¼ä¸€å®šæ˜¯é€šé€šåœ¨ master!)</em></p>
<blockquote>
<p>è«‹åœ¨è‡ªå·± side_project ä¸Šé€™æ¨£åš</p>
</blockquote>
<p>åªåœ¨ master ä¸Šé–‹ç™¼ï¼Œç¨‹å¼å¿…é ˆç­‰åˆ°åŠŸèƒ½é–‹ç™¼å®Œå…¨æ‰èƒ½ releaseï¼Œä¸­é€” release æœƒå½±éŸ¿åˆ°ç¾æœ‰ã€æˆ–åˆ¥äººåšçš„åŠŸèƒ½ã€‚<br><img src="https://i.imgur.com/kCbpXQq.png"></p>
<p>é–‹ç™¼è¤‡é›œåº¦å°å¾ˆå¤šï¼Œä½†çœŸçš„æ²’æœ‰å…¬å¸é€™æ¨£ç”¨ã€‚</p>
<hr>
<p><strong>Feature Branch</strong></p>
<blockquote>
<p>ç‚ºäº†å”ä½œé–‹ç™¼ï¼Œé–‹ç™¼ A åŠŸèƒ½çš„æ™‚å€™ä¹Ÿèƒ½åŒæ™‚é–‹ç™¼ B åŠŸèƒ½ï¼Œä¹Ÿä¸æœƒå½±éŸ¿åˆ°å…¶ä»– release çš„æ±è¥¿ã€‚</p>
</blockquote>
<p><img src="https://i.imgur.com/JJNaYvP.png"><br>é–‹å¦ä¸€æ”¯åˆ†æ”¯ï¼Œå…¨éƒ¨å®Œæˆå† releaseï¼Œä¸­é€” release master ä¹Ÿä¸æœƒå½±éŸ¿åˆ°ç¾æœ‰åŠŸèƒ½ï¼Œä½†éš¨è‘—åŠŸèƒ½çš„é–‹ç™¼æ™‚é–“æ‹‰é•·ï¼Œmerge å› master çš„æ™‚å€™è¡çªå¯èƒ½å¾ˆå¤šï¼Œcode_review ä¹Ÿæœƒå¾ˆå¤§åŒ…ï¼Œä¹Ÿæœ‰å¯èƒ½æœ‰é‡å·¥çš„ç‹€æ³ã€‚</p>
<hr>
<p><strong>trunk_base_flow</strong></p>
<blockquote>
<p>é™ä½æ¯å€‹ commit ç²’åº¦ï¼Œbranch çš„é€±æœŸï¼Œmerge çš„æ™‚å€™æ›´ easy</p>
</blockquote>
<p><img src="https://i.imgur.com/AKeir5a.png"></p>
<p>merge å› master æ™‚ä¸æœƒä¸€æ¬¡è¦è§£å¾ˆå¤šè¡çªï¼Œcode_review æ–¹ä¾¿ï¼ŒæŒçºŒæ•´åˆï¼ŒåŠ å¿«è¿­ä»£ã€‚</p>
<div class="note info"><p>Qï¼šä½†é€™æ¨£ä¸å°±æŠŠæœªå®Œæˆçš„åŠŸèƒ½ä¸€èµ· release å‡ºå»äº†å—ï¼Ÿ<br><strong>Aï¼šæ‰€ä»¥æˆ‘å€‘æ­é… Feature Toggles/Flags ï¼Œä¾†éš±è—å°šæœªå®Œæˆçš„åŠŸèƒ½ï¼</strong></p>
</div>


<h1 id="rails-çš„-Feature-Toggles"><a href="#rails-çš„-Feature-Toggles" class="headerlink" title="rails çš„ Feature Toggles"></a>rails çš„ Feature Toggles</h1><h2 id="Unleash"><a href="#Unleash" class="headerlink" title="Unleash"></a><a href="https://github.com/Unleash/unleash">Unleash</a></h2><blockquote>
<p>ğŸ‘†<em>å®˜æ–¹æ–‡ä»¶ï¼Œè«‹é»æ¨™é¡Œ</em></p>
</blockquote>
<p>æ–‡ä»¶è©³ç´°ï¼Œä½†è¤‡é›œåº¦ä¹Ÿå¾ˆé«˜ï¼Œè¦å¦æ¶ä¸€å€‹ serverï¼Œè‡ªå·±ä¸²æ¥ API</p>
<p><img src="https://i.imgur.com/jQRpQFh.png"></p>
<h2 id="Flipper-and-Rollout"><a href="#Flipper-and-Rollout" class="headerlink" title="Flipper and  Rollout"></a><a href="https://github.com/jnunemaker/flipper">Flipper</a> and  <a href="https://github.com/fetlife/rollout">Rollout</a></h2><blockquote>
<p>ğŸ‘†<em>å®˜æ–¹æ–‡ä»¶ï¼Œè«‹é»æ¨™é¡Œ</em></p>
</blockquote>
<p>rollout æ˜¯ä»°è³´ redis å»åšé–‹é—œçš„æ§åˆ¶ï¼Œè€Œ Flipper æ˜¯å¯ä»¥æŒ‡å®šä½ è¦ç”¨ä»€éº¼æ–¹å¼å»å­˜å–é–‹é—œçš„è³‡æ–™ã€‚<br>åŸºæœ¬åšæ³•éƒ½å·®ä¸å¤šï¼Œä¹Ÿéƒ½æœ‰å¦å¤–çš„ ui å¯ä»¥ç”¨ï¼Œç”šè‡³å¯ä»¥æŒ‡å®šèª°å¯ä»¥åŸ·è¡Œã€ç™¾åˆ†æ¯”é‡‹å‡º</p>
<blockquote>
<p>ps. Flipper æ”¯æ´ rolloutï¼Œä¹Ÿå°±æ˜¯ä½ å¯ä»¥ç”¨ Flipper æŠŠ Rollout åŒ…èµ·ä¾†</p>
</blockquote>
<div class="note info"><p>é–‹é—œæœ‰åˆ†å…©ç¨®ï¼Œä¸€ç¨®å°±æ˜¯å¾ˆç°¡å–®çš„é–‹è·Ÿé—œï¼Œå¦ä¸€ç¨®æ˜¯å¯ä»¥ä¾ç…§ç™¾åˆ†æ¯”é‡‹å‡ºçš„ã€‚</p>
</div>

<h1 id="å¯¦ä½œ-ä»¥-active-record-ç‚ºä¾‹"><a href="#å¯¦ä½œ-ä»¥-active-record-ç‚ºä¾‹" class="headerlink" title="å¯¦ä½œ(ä»¥ active_record ç‚ºä¾‹)"></a>å¯¦ä½œ(ä»¥ <code>active_record</code> ç‚ºä¾‹)</h1><h2 id="install"><a href="#install" class="headerlink" title="install"></a>install</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># In Your Gemfile.rb</span></span><br><span class="line">gem <span class="string">&#x27;flipper&#x27;</span></span><br><span class="line">gem <span class="string">&#x27;flipper-active_record&#x27;</span></span><br></pre></td></tr></table></figure>
<p>è«‹è¨˜å¾— <code>bundle</code>ï¼Œæ¥è‘—ä½¿ç”¨<code>rails g flipper:active_record</code></p>
<p>é€™æœƒå¹«ä½  create å…©å€‹ table</p>
<ol>
<li><code>flipper_features</code></li>
<li><code>flipper_gates</code><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CreateFlipperTables</span> &lt; ActiveRecord::Migration[6.1]</span></span><br><span class="line">  def <span class="keyword">self</span>.up</span><br><span class="line">    create_table <span class="symbol">:flipper_features</span> <span class="keyword">do</span> <span class="params">|t|</span></span><br><span class="line">      t.string <span class="symbol">:key</span>, <span class="symbol">null:</span> <span class="literal">false</span> <span class="comment">#  feature çš„åç¨±</span></span><br><span class="line">      t.timestamps <span class="symbol">null:</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    add_index <span class="symbol">:flipper_features</span>, <span class="symbol">:key</span>, <span class="symbol">unique:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    create_table <span class="symbol">:flipper_gates</span> <span class="keyword">do</span> <span class="params">|t|</span></span><br><span class="line">      t.string <span class="symbol">:feature_key</span>, <span class="symbol">null:</span> <span class="literal">false</span> <span class="comment"># feature çš„åç¨±</span></span><br><span class="line">      t.string <span class="symbol">:key</span>, <span class="symbol">null:</span> <span class="literal">false</span> <span class="comment"># æ§åˆ¶é–‹é—œçš„ type</span></span><br><span class="line">      t.string <span class="symbol">:value</span>	      <span class="comment"># éš¨è‘— type ä¸ä¸€æ¨£æœ‰ä¸ä¸€æ¨£çš„å€¼</span></span><br><span class="line">      t.timestamps <span class="symbol">null:</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    add_index <span class="symbol">:flipper_gates</span>, [<span class="symbol">:feature_key</span>, <span class="symbol">:key</span>, <span class="symbol">:value</span>], <span class="symbol">unique:</span> <span class="literal">true</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  def <span class="keyword">self</span>.down</span><br><span class="line">    drop_table <span class="symbol">:flipper_gates</span></span><br><span class="line">    drop_table <span class="symbol">:flipper_features</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
è¨˜å¾— migration!<div class="note info"><p><code>flipper_features</code> åªè¨˜æœ‰å“ªäº›é–‹é—œï¼Œ<code>flipper_gates</code> è¨˜ä½ è¦æ€éº¼æ§åˆ¶é€™å€‹é–‹é—œ</p>
</div>

</li>
</ol>
<p>åˆ°é€™é‚Šå…¶å¯¦å·²ç¶“å¯ä»¥ç›´æ¥åœ¨ console ä½¿ç”¨ feature_toggle çš„åŠŸèƒ½äº†ã€‚</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rails console</span></span><br><span class="line">Flipper.enable(<span class="symbol">:search</span>) <span class="comment"># æœƒå¹«ä½ ç›´æ¥åŠ å…¥è³‡æ–™</span></span><br><span class="line"><span class="comment"># å¯ä»¥ä½¿ç”¨ä¸‹æ–¹ä¾†æŸ¥çœ‹ä½ çš„é–‹é—œã€‚</span></span><br><span class="line">pp Flipper::Adapters::ActiveRecord::Feature.all</span><br><span class="line"><span class="comment"># [#&lt;Flipper::Adapters::ActiveRecord::Feature:0x00007f97e8f05cd0</span></span><br><span class="line"><span class="comment">#   id: 1,</span></span><br><span class="line"><span class="comment">#   key: &quot;search&quot;,</span></span><br><span class="line"><span class="comment">#   created_at: Sat, 31 Jul 2021 06:20:03.158525000 UTC +00:00,</span></span><br><span class="line"><span class="comment">#   updated_at: Sat, 31 Jul 2021 06:20:03.158525000 UTC +00:00&gt;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹æ–¹å¯ä»¥çœ‹åˆ°ä½ æ§åˆ¶é–‹é—œçš„æ–¹å¼(è¦ enableæ‰æœƒ create è³‡æ–™ï¼Œdisable å°±åˆªæ‰è³‡æ–™)</span></span><br><span class="line">pp Flipper::Adapters::ActiveRecord::Gate.all</span><br><span class="line"><span class="comment"># [#&lt;Flipper::Adapters::ActiveRecord::Gate:0x00007f97e8e6e920</span></span><br><span class="line"><span class="comment">#   id: 1,</span></span><br><span class="line"><span class="comment">#   feature_key: [FILTERED],</span></span><br><span class="line"><span class="comment">#   key: &quot;boolean&quot;,</span></span><br><span class="line"><span class="comment">#   value: &quot;true&quot;,</span></span><br><span class="line"><span class="comment">#   created_at: Sat, 31 Jul 2021 06:26:55.841467000 UTC +00:00,</span></span><br><span class="line"><span class="comment">#   updated_at: Sat, 31 Jul 2021 06:26:55.841467000 UTC +00:00&gt;]</span></span><br></pre></td></tr></table></figure>
<p>ä¸éè¦åœ¨ controller ä¸­èª¿ç”¨ Flipper çš„æ–¹æ³•ï¼Œå¿…é ˆå…ˆ initializeï¼Œæˆ–è€…ç›´æ¥å»ºç«‹ä¸€ä»½æª”æ¡ˆï¼Œæ”¾åœ¨ <code>lib/</code> ä¸­</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config/initializers/flipper/feature.rb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># initializer</span></span><br><span class="line">Flipper.configure <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.adapter &#123; Flipper::Adapters::ActiveRecord.new &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–çš„æ™‚å€™å°±è¨­å®š group</span></span><br><span class="line">Flipper.register(<span class="symbol">:admins</span>) &#123; <span class="params">|thing|</span> thing.admin? &#125;</span><br></pre></td></tr></table></figure>

<h2 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># In Your Gemfile.rb</span></span><br><span class="line">gem <span class="string">&#x27;flipper-ui&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>è¨˜å¾— <code>bundle</code>ï¼Œæ¥è‘—è¨­å®šä½ çš„ router!</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config/routes.rb</span></span><br><span class="line">YourRailsApp::Application.routes.draw <span class="keyword">do</span></span><br><span class="line">  mount Flipper::UI.app(Flipper) =&gt; <span class="string">&#x27;/flipper&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>è‹¥è¦ä¾è³´ devise è¨­å®šæ¬Šé™ï¼Œexample:</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># initializers/admin_access.rb</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CanAccessFlipperUI</span></span></span><br><span class="line">  def <span class="keyword">self</span>.matches?(request)</span><br><span class="line">    current_user = request.env[<span class="string">&#x27;warden&#x27;</span>].user</span><br><span class="line">    current_user.present? &amp;&amp; current_user.respond_to?(<span class="symbol">:admin?</span>) &amp;&amp; current_user.admin?</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config/routes.rb</span></span><br><span class="line"></span><br><span class="line">constraints CanAccessFlipperUI <span class="keyword">do</span></span><br><span class="line">  mount Flipper::UI.app(Flipper) =&gt; <span class="string">&#x27;/flipper&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æˆ–æ˜¯ç›´æ¥ä½¿ç”¨ devise_group åšè¼”åŠ©</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">devise_scope <span class="symbol">:admin</span> <span class="keyword">do</span></span><br><span class="line">  authenticated <span class="symbol">:admin</span> <span class="keyword">do</span></span><br><span class="line">    mount Flipper::UI.app(Flipper) =&gt; <span class="string">&#x27;/flipper&#x27;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>UI çš„éƒ¨åˆ†å¯ä»¥åªèƒ½ç¨å¾®å®¢è£½åŒ–ï¼Œå½ˆæ€§ä¸å¤§</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># config/initializers/flipper_ui_config.rb</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;flipper/ui&#x27;</span></span><br><span class="line"></span><br><span class="line">Flipper::UI.configure <span class="keyword">do</span> <span class="params">|config|</span></span><br><span class="line">  config.banner_text = <span class="string">&#x27;Production Environment&#x27;</span></span><br><span class="line">  config.banner_class = <span class="string">&#x27;danger&#x27;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<div class="note info"><p>ç”±æ–¼æ²’æœ‰ç”Ÿå‡ºä»»ä½•çš„æª”æ¡ˆè®“ä½ åšä¿®æ”¹ï¼Œæ‰€ä»¥è¦å®¢è£½åŒ–ï¼Œåªèƒ½åœ¨ <code>config/initializers/</code> è£¡æ–°å¢æª”æ¡ˆï¼Œåœ¨æª”æ¡ˆè£¡ <code>require flipper/**</code> çš„ç›¸é—œæª”æ¡ˆæ‰èƒ½é€²è¡Œè¨­å®šã€‚<strong>ä¹Ÿå°±æ˜¯æ”¹ä¸€æ¬¡å°±è¦é—œä¸€æ¬¡ server å–”</strong></p>
</div>


</li>
</ul>
<h2 id="Flipper-æ§åˆ¶é–‹é—œçš„æ–¹æ³•-Gates"><a href="#Flipper-æ§åˆ¶é–‹é—œçš„æ–¹æ³•-Gates" class="headerlink" title="Flipper æ§åˆ¶é–‹é—œçš„æ–¹æ³• Gates"></a>Flipper æ§åˆ¶é–‹é—œçš„æ–¹æ³• Gates</h2><blockquote>
<p>flipper_gates çš„ key</p>
</blockquote>
<h3 id="Boolean"><a href="#Boolean" class="headerlink" title="Boolean"></a>Boolean</h3><ul>
<li>åªæœ‰é–‹è·Ÿé—œçš„é¸é …<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">Flipper.enable(<span class="symbol">:search</span>)</span><br><span class="line">Flipper.enabled?(<span class="symbol">:search</span>) <span class="comment"># true</span></span><br></pre></td></tr></table></figure>
<h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3></li>
<li>å…ˆè£½ä½œå¥½ group<ul>
<li>ä½¿ç”¨ <code>Flipper.register(:admins) &#123; |thing| thing.admin? &#125;</code>ï¼Œ<strong>æ‰€ä»¥ä½ çš„ thing è¦æœ‰ admin? é€™å€‹æ–¹æ³•å¯ä»¥ç”¨</strong></li>
<li>å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>Flipper.enabled?(:feature_name, current_user)</code> å»åšåˆ¤æ–·ã€‚<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">Flipper.register(<span class="symbol">:admins</span>) &#123; <span class="params">|thing|</span> thing.admin? &#125;</span><br><span class="line"></span><br><span class="line">Flipper.enabled?(<span class="symbol">:feature_name</span>, admin_user) <span class="comment"># true</span></span><br><span class="line">Flipper.enabled?(<span class="symbol">:feature_name</span>, non_admin_user) <span class="comment">#false</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="actor"><a href="#actor" class="headerlink" title="actor"></a>actor</h3><ul>
<li>ç›´æ¥ä½¿ç”¨ <code>flipper_id</code> æŒ‡å®šèª°(ex. <code>user</code>ã€<code>company</code>)å¯ä»¥éé–‹é—œï¼Œ<strong>è«‹è¨˜å¾—ä¸€å®šè¦æœ‰ flipper_id é€™å€‹æ–¹æ³•å¯ä»¥ç”¨ï¼Œå› ç‚º gates æ˜¯èªé€™å€‹ï¼</strong><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># model/user.rb</span></span><br><span class="line">alias_method <span class="symbol">:flipper_id</span>, <span class="symbol">:id</span></span><br></pre></td></tr></table></figure>
<div class="note info"><p>å¯¦ä½œèµ·ä¾†çš„å¯¦éš›ç‹€æ³ï¼š<br>å°±ç®—æ²’æœ‰è¨­å®š<code>flipper_id</code> é€™å€‹æ–¹æ³•ï¼Œé è¨­å¥½åƒä¹Ÿæ˜¯æŠ“ <code>id</code>ï¼Œä½† value é‚£ä¸€æ ¼å­˜çš„æœƒæ˜¯ <code>User;1</code>ï¼Œæœ‰è¨­å®šçš„è©±å°±æœƒæ˜¯ä½ è¨­å®šçš„ value</p>
</div>

</li>
</ul>
<h3 id="ç™¾åˆ†æ¯”æ¨¡å¼"><a href="#ç™¾åˆ†æ¯”æ¨¡å¼" class="headerlink" title="ç™¾åˆ†æ¯”æ¨¡å¼"></a>ç™¾åˆ†æ¯”æ¨¡å¼</h3><h4 id="percentage-of-actors"><a href="#percentage-of-actors" class="headerlink" title="percentage_of_actors"></a><code>percentage_of_actors</code></h4><ul>
<li>è¨­å®šç‚ºæ•´å€‹ç³»çµ±ä¸­ï¼Œå¤šå°‘ç™¾åˆ†æ¯” çš„ actors æ‰“é–‹</li>
<li>ä¸éè¦é€™æ¨£ç”¨çš„è©±ä¸€å®šè¦åŠ  <code>alias_method :flipper_id, :id</code>ï¼Œåœ¨ä½ è¦æ§åˆ¶çš„ model è£¡</li>
<li>æ¯å€‹åŠŸèƒ½æ‡‰è©²è¦åªæœ‰ä¸€ç¨® actor<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">Flipper.enable <span class="symbol">:feature_name</span>, Flipper.actors(<span class="number">10</span>)</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">Flipper.enable_percentage_of_actors <span class="symbol">:feature_name</span>, <span class="number">10</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="percentage-of-time"><a href="#percentage-of-time" class="headerlink" title="percentage_of_time"></a><code>percentage_of_time</code></h4><ul>
<li>ç”¨æ©Ÿç‡çš„æ–¹å¼æ±ºå®šæ˜¯å¦é–‹å•ŸåŠŸèƒ½ã€‚<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸è«–æ˜¯å¦æœ‰çµ¦ç¬¬äºŒå€‹åƒæ•¸ï¼Œçš†æœ‰ 25% æ©Ÿç‡ç‚º true</span></span><br><span class="line">Flipper.enable_percentage_of_time(<span class="symbol">:new_feature</span>, <span class="number">25</span>)</span><br><span class="line"></span><br><span class="line">Flipper.enabled?(<span class="symbol">:new_feature</span>) <span class="comment"># 25% æ©Ÿç‡ç‚º true </span></span><br><span class="line">Flipper.enabled?(<span class="symbol">:new_feature</span>, user)<span class="comment"># 25% æ©Ÿç‡ç‚º true</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="ç¸½çµ"><a href="#ç¸½çµ" class="headerlink" title="ç¸½çµ"></a>ç¸½çµ</h1><p>feature_toggle é›–ç„¶å¥½ç”¨ï¼Œä½†è«‹è¨˜å¾—ï¼š</p>
<ol>
<li>toggle å¤ªå¤šï¼Œæœƒä¸å¥½ç¶­è­· =&gt; ä½ å¯èƒ½è¦ç¶­è­·å…©ç‰ˆã€‚</li>
<li>toggle çš„åŠŸèƒ½ç²’åº¦å¤ªå¤§ï¼Œä½†èƒ½æ§åˆ¶çš„ç´°ç¯€æ˜¯æœ‰é™çš„ï¼Œè«‹ç¶­æŒé©ä¸­çš„ç²’åº¦å¤§å°</li>
<li>æ¯å€‹ toggle çš„åŠŸèƒ½ï¼Œç›¡é‡ä¸è¦è€¦åˆåˆ°å…¶ä»– toggle çš„åŠŸèƒ½ï¼Œè«‹åˆ¥ææ­»è‡ªå·±XDâ€</li>
<li>é‚„æ˜¯æœƒæœ‰æçˆ† production çš„é¢¨éšªå•Šï¼</li>
</ol>
<h2 id="è¦ç¯„å¯åƒè€ƒ-gitLab-çš„-ä½¿ç”¨åŸå‰‡"><a href="#è¦ç¯„å¯åƒè€ƒ-gitLab-çš„-ä½¿ç”¨åŸå‰‡" class="headerlink" title="è¦ç¯„å¯åƒè€ƒ gitLab çš„ ä½¿ç”¨åŸå‰‡"></a>è¦ç¯„å¯åƒè€ƒ <a href="https://docs.gitlab.com/ee/development/feature_flags/">gitLab çš„ ä½¿ç”¨åŸå‰‡</a></h2><p><img src="https://i.imgur.com/BGH0MiZ.png"></p>
<h1 id="åƒè€ƒæ–‡ç« "><a href="#åƒè€ƒæ–‡ç« " class="headerlink" title="åƒè€ƒæ–‡ç« "></a>åƒè€ƒæ–‡ç« </h1><ol>
<li><a href="https://itw01.com/5JWE4D6.html">Feature Flag åŠŸèƒ½é‡‹å‡ºæ§åˆ¶</a></li>
<li><a href="https://mileschou.github.io/blog/feature-toggle-faq/">Feature Toggle æ‡‰ç”¨å¸¸è¦‹å•é¡Œ</a></li>
<li><a href="https://www.flippercloud.io/docs#features">Flipper Cloud</a></li>
</ol>
]]></content>
      <categories>
        <category>Ruby on Rails</category>
      </categories>
      <tags>
        <tag>Ruby on Rails</tag>
        <tag>feature_toggle</tag>
      </tags>
  </entry>
  <entry>
    <title>Single-table inheritance And Polymorphic</title>
    <url>/2021/12/08/single_table_inheritance_and_polymorphic/</url>
    <content><![CDATA[<h1 id="STI-èˆ‡-å¤šå‹é—œè¯-çš„-combo-æŠ€"><a href="#STI-èˆ‡-å¤šå‹é—œè¯-çš„-combo-æŠ€" class="headerlink" title="STI èˆ‡ å¤šå‹é—œè¯ çš„ combo æŠ€"></a>STI èˆ‡ å¤šå‹é—œè¯ çš„ combo æŠ€</h1><h3 id="å…ˆä¾†å‡è¨­ä¸€å€‹æƒ…å¢ƒ"><a href="#å…ˆä¾†å‡è¨­ä¸€å€‹æƒ…å¢ƒ" class="headerlink" title="å…ˆä¾†å‡è¨­ä¸€å€‹æƒ…å¢ƒ"></a>å…ˆä¾†å‡è¨­ä¸€å€‹æƒ…å¢ƒ</h3><p>ä½¿ç”¨è€…å¯ä»¥è¨‚é–±ä¸åŒçš„æ–¹æ¡ˆï¼Œå¹´ç¹³æˆ–æœˆç¹³ä¹‹é¡çš„</p>
<h2 id="1-å–®ä¸€è¡¨æ ¼ç¹¼æ‰¿-STI-Single-table-inheritance"><a href="#1-å–®ä¸€è¡¨æ ¼ç¹¼æ‰¿-STI-Single-table-inheritance" class="headerlink" title="1. å–®ä¸€è¡¨æ ¼ç¹¼æ‰¿ STI (Single-table inheritance)"></a>1. <strong>å–®ä¸€è¡¨æ ¼ç¹¼æ‰¿ STI</strong> (Single-table inheritance)</h2><ol>
<li><code>YearPlan</code> å’Œ <code>MonthPlan</code> <code>å…±ç”¨ï¼ŒPlan</code> é€™å€‹ <code>table</code></li>
</ol>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Table name: plans</span></span><br><span class="line"><span class="comment">#  id                :bigint           not null, primary key</span></span><br><span class="line"><span class="comment">#  type              :string(191)      not null</span></span><br><span class="line"><span class="comment">#  status            :integer          default(&quot;pending&quot;)</span></span><br><span class="line"><span class="comment">#  amount            :integer</span></span><br><span class="line"><span class="comment">#  created_at        :datetime         not null</span></span><br><span class="line"><span class="comment">#  updated_at        :datetime         not null</span></span><br></pre></td></tr></table></figure>

<p>STI å–®ä¸€è¡¨æ ¼ç¹¼æ‰¿ï¼Œæœƒæ ¹æ“šä½ ä½¿ç”¨å»ºç«‹çš„ <code>model</code> åœ¨ <code>plans</code> çš„é€™å€‹ <code>table</code> çš„ <code>type</code> ä¸­ç´€éŒ„ <code>model_name</code></p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># model/plan.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Plan</span> &lt; ApplicationRecord</span></span><br><span class="line">  <span class="comment"># do_something</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># model/foo_plan.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YearPlan</span> &lt; Plan</span></span><br><span class="line">  <span class="comment"># do_something</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># model/boo_plan.rb</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MonthPlan</span> &lt; Plan</span></span><br><span class="line">  <span class="comment"># do_something</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ex. </p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rails console</span></span><br><span class="line">YearPlan.create!(<span class="symbol">amount:</span> <span class="number">999</span>, <span class="symbol">status:</span> <span class="string">&quot;active&quot;</span>)</span><br><span class="line"></span><br><span class="line">MonthPlan.create!(<span class="symbol">amount:</span> <span class="number">99</span>, <span class="symbol">status:</span> <span class="string">&quot;active&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>é€™æ¨£çš„æƒ…æ³ï¼Œæœƒåœ¨ <code>plans</code> çš„ <code>table</code> ä¸­ å»ºç«‹ä¸€ç­† <code>type</code> åˆ†åˆ¥ç‚º <code>&quot;YearPlan&quot;</code>ã€<code>&quot;MonthPlan&quot;</code> çš„ record<br><img src="https://i.imgur.com/715jUoM.png"></p>
<p>è€Œåœ¨ console <code>YearPlan.last</code>ï¼Œåªæ˜¯å» <code>Plans</code> é€™å€‹ <code>table</code> æ‰¾<br><img src="https://i.imgur.com/GdAzqgL.png"></p>
<div class="note info"><p>å› ç‚ºé€™å€‹åŠŸèƒ½ï¼Œåœ¨ rails è£¡ï¼Œcolumn çš„åå­—ä¸èƒ½äº‚å–æˆ type</p>
</div>
<h2 id="2-å¤šå‹é—œè¯-polymorphic"><a href="#2-å¤šå‹é—œè¯-polymorphic" class="headerlink" title="2. å¤šå‹é—œè¯ polymorphic"></a>2. å¤šå‹é—œè¯ polymorphic</h2><p>å…ˆå‡è¨­å¦å¤–ä¸€å€‹å–®ç´”çš„æƒ…å¢ƒä¾†è¬› polymorphicï¼Œä»¥ <a href="https://ihower.tw/rails/activerecord-relationships.html">Railså¯¦æˆ°è–ç¶“</a>è£¡é¢çš„ä¾‹å­ï¼Œairtcleã€photo éƒ½å¯ä»¥è¢« comment<br>æ‰€ä»¥ comment å¯ä»¥ç”¨å¤šå‹çš„é—œä¿‚æŒ‡å‘ä¸åŒçš„ model é—œè¯ã€‚</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span> &lt; ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:commentable</span>, <span class="symbol">polymorphic:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span> &lt; ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:comments</span>, <span class="symbol">as:</span> <span class="symbol">:commentable</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Photo</span> &lt; ApplicationRecord</span></span><br><span class="line">  has_many <span class="symbol">:comments</span>, <span class="symbol">as:</span> <span class="symbol">:commentable</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">article = Article.first</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€éé—œé€£æ–°å¢ç•™è¨€</span></span><br><span class="line">comment = article.comments.create(<span class="symbol">:content</span> =&gt; <span class="string">&quot;First Comment&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½ å¯ä»¥ç™¼ç¾ Rails å¾ˆè°æ˜çš„å¹«æˆ‘å€‘æŒ‡å®šäº†è¢«ç•™è¨€ç‰©ä»¶çš„ç¨®é¡å’Œid</span></span><br><span class="line">comment.commentable_type =&gt; <span class="string">&quot;Article&quot;</span></span><br><span class="line">comment.commentable_id =&gt; <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯ä»¥é€é commentable åå‘å›æŸ¥é—œé€£çš„ç‰©ä»¶</span></span><br><span class="line">comment.commentable =&gt; #&lt;Article id: 1, ....&gt;</span><br></pre></td></tr></table></figure>
<div class="note warning"><p>åˆ°é€™è£¡æˆ‘ä¸€ç›´éƒ½èªç‚ºï¼Œåœ¨å¯«å…¥çš„ <code>commentable_type</code> ï¼Œæ˜¯å»æŠ“å–ç‰©ä»¶çš„ model(class) nameï¼Œç›´åˆ°ä»–èˆ‡ STI ç›¸é‡äº†â€¦â€¦</p>
</div>

<h2 id="å›åˆ°-STI-èˆ‡-polymorphic"><a href="#å›åˆ°-STI-èˆ‡-polymorphic" class="headerlink" title="å›åˆ° STI èˆ‡ polymorphic"></a>å›åˆ° STI èˆ‡ polymorphic</h2><p>ä½¿ç”¨è€…å¯ä»¥åˆ†åˆ¥è¨‚é–±ä¸åŒçš„æ–¹æ¡ˆï¼Œä½†å…¶å¯¦å¯ä»¥é–‹æˆä¸€å€‹ model å°±å¥½ã€‚</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subscription</span> &lt; ApplicationRecord</span></span><br><span class="line">  belongs_to <span class="symbol">:planable</span>, <span class="symbol">polymorphic:</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Table name: subscriptions</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  id                       :bigint           not null, primary key</span></span><br><span class="line"><span class="comment">#  planable_type            :string(191)</span></span><br><span class="line"><span class="comment">#  planable_id              :integer</span></span><br><span class="line"><span class="comment">#  status                   :integer          default(&quot;active&quot;)</span></span><br><span class="line"><span class="comment">#  created_at               :datetime         not null</span></span><br><span class="line"><span class="comment">#  updated_at               :datetime         not null</span></span><br></pre></td></tr></table></figure>

<p>é€™æ¨£çš„æƒ…æ³é æœŸå¯ä»¥è®“ <code>Subscription</code> æ ¹æ“š <code>planable</code> å¸¶é€²ä¾†çš„ <code>record</code> å»æ‰¾åˆ°ç›¸é—œé€£çš„ <code>object</code></p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">my_plan = YearPlan.last</span><br><span class="line"></span><br><span class="line">record = Subscription.create!(<span class="symbol">planable:</span> my_plan, <span class="symbol">status:</span> <span class="string">&quot;active&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://i.imgur.com/55rWh04.png"></p>
<p>æ¥è‘—è®“æˆ‘å€‘ä¾†çœ‹çœ‹ é€™å€‹ record</p>
<p><img src="https://i.imgur.com/ZVlpdzx.png"></p>
<p><code>planable_type</code> å¯«çš„æ˜¯ å¯«çš„æ˜¯ <code>Plan</code> ï¼Œä¸æ˜¯ <code>YearPlan</code> ï¼Œæ‰€ä»¥çœ‹èµ·ä¾†æ˜¯å»æŠ“ä»–çš„ <code>table_name</code>ï¼Œè¦æ³¨æ„ï¼</p>
<h2 id="ğŸ’¡-è§£æ³•"><a href="#ğŸ’¡-è§£æ³•" class="headerlink" title="ğŸ’¡ è§£æ³•"></a>ğŸ’¡ è§£æ³•</h2><figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">before_validation <span class="symbol">:set_type</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_type</span></span></span><br><span class="line">  <span class="keyword">self</span>.planable_type = planable.<span class="keyword">class</span>.name</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è‹¥æœ‰ä»»ä½•æŒ‡æ•™ï¼Œæ­¡è¿ç•™è¨€çµ¦æˆ‘ã€‚ğŸ™</p>
<h3 id="åƒè€ƒè³‡æ–™"><a href="#åƒè€ƒè³‡æ–™" class="headerlink" title="åƒè€ƒè³‡æ–™"></a>åƒè€ƒè³‡æ–™</h3><ol>
<li><a href="https://stackoverflow.com/questions/9628610/why-polymorphic-association-doesnt-work-for-sti-if-type-column-of-the-polymorph">stack over flow</a></li>
<li><a href="https://ihower.tw/rails/activerecord-relationships.html">Railså¯¦æˆ°è–ç¶“</a></li>
</ol>
]]></content>
      <categories>
        <category>Ruby on Rails</category>
      </categories>
      <tags>
        <tag>Ruby on Rails</tag>
      </tags>
  </entry>
</search>
